{"version":3,"sources":["../src/resources/monitoring.ts"],"sourcesContent":["import { randomUUID } from \"crypto\";\n\nimport type { Hamming, RunContext } from \"../index\";\n\nimport {\n  MonitoringItem as IMonitoringItem,\n  ITracing,\n  InputType,\n  MetadataType,\n  MonitoringItemStatus,\n  MonitoringSession,\n  MonitoringTrace,\n  OutputType,\n  TracingMode,\n  MonitoringTraceContext,\n} from \"../types\";\nimport { asyncRunContext } from \"../asyncStorage\";\n\nfunction newRunContext(seqId: number): RunContext {\n  return {\n    tracing: {\n      monitoring: {\n        seqId,\n      },\n    },\n  };\n}\n\nclass MonitoringItem implements IMonitoringItem {\n  monitoring: Monitoring;\n  sessionId: string;\n  seqId: number;\n  input: InputType | undefined;\n  output: OutputType | undefined;\n  metadata: MetadataType | undefined;\n  metrics: Record<string, any>;\n  status: MonitoringItemStatus;\n  errorMessage: string | undefined;\n  startTs: number;\n\n  tracing: ITracing;\n\n  constructor(monitoring: Monitoring, sessionId: string, seqId: number) {\n    this.monitoring = monitoring;\n    this.sessionId = sessionId;\n    this.seqId = seqId;\n    this.metrics = {};\n  }\n\n  setInput(input: InputType) {\n    this.input = input;\n  }\n\n  setOutput(output: OutputType) {\n    this.output = output;\n  }\n\n  setMetadata(metadata: MetadataType) {\n    this.metadata = metadata;\n  }\n\n  _start() {\n    this.startTs = Date.now();\n    this.status = MonitoringItemStatus.STARTED;\n  }\n\n  _end(error: boolean = false, errorMessage?: string) {\n    if (this._hasEnded()) return;\n\n    this.metrics.duration_ms = Date.now() - this.startTs;\n    this.status = error\n      ? MonitoringItemStatus.FAILED\n      : MonitoringItemStatus.COMPLETED;\n    this.errorMessage = errorMessage;\n    this.monitoring._endItem(this._toTrace());\n  }\n\n  _hasEnded() {\n    return [\n      MonitoringItemStatus.COMPLETED,\n      MonitoringItemStatus.FAILED,\n    ].includes(this.status);\n  }\n\n  _toTrace(): MonitoringTrace {\n    return {\n      session_id: this.sessionId,\n      seq_id: this.seqId,\n      parent_seq_id: null,\n      event: {\n        kind: \"root\",\n        input: this.input,\n        output: this.output,\n        metadata: this.metadata,\n        metrics: this.metrics,\n        status: this.status,\n        error_message: this.errorMessage,\n      },\n    };\n  }\n}\n\nexport class Monitoring {\n  client: Hamming;\n  private session: MonitoringSession | null;\n\n  constructor(client: Hamming) {\n    this.client = client;\n  }\n\n  start() {\n    console.log(\"Monitoring started!\");\n    if (!this.session) {\n      this.session = {\n        id: randomUUID(),\n        seqId: 0,\n      };\n    }\n    this.client._logger.start();\n    this.client.tracing._setMode(TracingMode.MONITORING);\n  }\n\n  stop() {\n    this.session = null;\n    this.client.tracing._setMode(TracingMode.OFF);\n    this.client._logger.stop();\n  }\n\n  async runItem(\n    callback: (item: IMonitoringItem) => unknown | Promise<unknown>,\n  ): Promise<unknown> {\n    const [sessionId, seqId] = this._nextSeqId();\n\n    const item = new MonitoringItem(this, sessionId, seqId);\n    item._start();\n\n    try {\n      const response = await asyncRunContext.run(\n        newRunContext(item.seqId),\n        async () => await callback(item),\n      );\n      if (!item.output) {\n        if (\n          response &&\n          response instanceof Object &&\n          !Array.isArray(response)\n        ) {\n          item.setOutput(response);\n        } else {\n          item.setOutput({ response });\n        }\n      }\n      item._end();\n\n      return response;\n    } catch (error) {\n      item._end(true, error.message);\n      throw error;\n    }\n  }\n\n  _endItem(trace: MonitoringTrace) {\n    this.client.tracing._logLiveTrace(trace);\n  }\n\n  _getTraceContext(): MonitoringTraceContext {\n    if (!this.session) throw Error(\"Monitoring not started\");\n\n    const [sessionId, seqId] = this._nextSeqId();\n    const runCtx = asyncRunContext.getStore();\n    const parentSeqId = runCtx?.tracing?.monitoring?.seqId ?? null;\n\n    return {\n      session_id: sessionId,\n      seq_id: seqId,\n      parent_seq_id: parentSeqId,\n    };\n  }\n\n  private _nextSeqId(): [string, number] {\n    if (!this.session) {\n      throw Error(\"Monitoring not started\");\n    }\n    this.session.seqId += 1;\n    return [this.session.id, this.session.seqId];\n  }\n}\n"],"mappings":"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","names":["randomUUID","newRunContext","seqId","MonitoringItem","monitoring","sessionId","__publicField","input","output","metadata","error","errorMessage","Monitoring","client","randomUUID","callback","item","response","asyncRunContext","trace","parentSeqId"]}