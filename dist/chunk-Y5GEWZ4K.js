import{a as u}from"./chunk-KN3XS55W.js";import{a as n}from"./chunk-GQSCBKA6.js";import{randomUUID as c}from"crypto";function g(a){return{tracing:{monitoring:{seqId:a}}}}var o=class{constructor(t,s,r){n(this,"monitoring");n(this,"sessionId");n(this,"seqId");n(this,"input");n(this,"output");n(this,"metadata");n(this,"metrics");n(this,"status");n(this,"errorMessage");n(this,"startTs");n(this,"tracing");this.monitoring=t,this.sessionId=s,this.seqId=r,this.metrics={}}setInput(t){this.input=t}setOutput(t){this.output=t}setMetadata(t){this.metadata=t}_start(){this.startTs=Date.now(),this.status="STARTED"}_end(t=!1,s){this._hasEnded()||(this.metrics.duration_ms=Date.now()-this.startTs,this.status=t?"FAILED":"COMPLETED",this.errorMessage=s,this.monitoring._endItem(this._toTrace()))}_hasEnded(){return["COMPLETED","FAILED"].includes(this.status)}_toTrace(){return{session_id:this.sessionId,seq_id:this.seqId,parent_seq_id:void 0,event:{kind:"root",input:this.input,output:this.output,metadata:this.metadata,metrics:this.metrics,status:this.status,error_message:this.errorMessage}}}},d=class{constructor(t){n(this,"client");n(this,"session");this.client=t}start(){console.log("Monitoring started!"),this.session||(this.session={id:c(),seqId:0}),this.client._logger.start(),this.client.tracing._setMode("monitoring")}stop(){this.session=null,this.client.tracing._setMode("off"),this.client._logger.stop()}async runItem(t){let[s,r]=this._nextSeqId(),e=new o(this,s,r);e._start();try{let i=await u.run(g(e.seqId),async()=>await t(e));return e.output||(i&&i instanceof Object&&!Array.isArray(i)?e.setOutput(i):e.setOutput({response:i})),e._end(),i}catch(i){throw e._end(!0,i.message),i}}startItem(){let[t,s]=this._nextSeqId(),r=new o(this,t,s);return r._start(),r}endItem(t,s){t instanceof o&&(t.output||(s&&s instanceof Object&&!Array.isArray(s)?t.setOutput(s):t.setOutput({response:s})),t._end())}_endItem(t){this.client.tracing._logLiveTrace(t)}_getTraceContext(){if(!this.session)throw Error("Monitoring not started");let[t,s]=this._nextSeqId(),e=u.getStore()?.tracing?.monitoring?.seqId;return{session_id:t,seq_id:s,parent_seq_id:e}}_nextSeqId(){if(!this.session)throw Error("Monitoring not started");return this.session.seqId+=1,[this.session.id,this.session.seqId]}};export{d as a};
//# sourceMappingURL=chunk-Y5GEWZ4K.js.map