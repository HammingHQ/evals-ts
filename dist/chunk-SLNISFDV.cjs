"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _optionalChain(ops) { let lastAccessLHS = undefined; let value = ops[0]; let i = 1; while (i < ops.length) { const op = ops[i]; const fn = ops[i + 1]; i += 2; if ((op === 'optionalAccess' || op === 'optionalCall') && value == null) { return undefined; } if (op === 'access' || op === 'optionalAccess') { lastAccessLHS = value; value = fn(value); } else if (op === 'call' || op === 'optionalCall') { value = fn((...args) => value.call(lastAccessLHS, ...args)); lastAccessLHS = undefined; } } return value; }var _chunkRX5AAJX7cjs = require('./chunk-RX5AAJX7.cjs');var _chunk7ARU3YXQcjs = require('./chunk-7ARU3YXQ.cjs');var a=512,o= exports.a =class{constructor(e){_chunk7ARU3YXQcjs.a.call(void 0, this,"client");_chunk7ARU3YXQcjs.a.call(void 0, this,"queue");_chunk7ARU3YXQcjs.a.call(void 0, this,"stopEvent");_chunk7ARU3YXQcjs.a.call(void 0, this,"queueNotEmptyEvent");this.client=e,this.queue=[],this.queue=[],this.stopEvent=!1,this.queueNotEmptyEvent=new _chunkRX5AAJX7cjs.a}log(e){this.queue.push(e),this.queueNotEmptyEvent.set()}async start(){for(;!this.stopEvent;)await this.queueNotEmptyEvent.wait(),this.stopEvent||await this._process_queue()}stop(){console.log("Waiting for logger thread to exit.."),this.stopEvent=!0}_drain_queue(){let e=[];for(;this.queue.length>0&&e.length<a;){let t=this.queue.shift();t!==void 0&&e.push(t)}return e}async _process_queue(){let e=this._drain_queue();await this._publish(e),this.queue.length>0?this.queueNotEmptyEvent.set():this.queueNotEmptyEvent.reset()}async _publish(e){console.log(`Publishing ${e.length} messages..`),console.log(`Messages: ${JSON.stringify(e)}`);try{await this.client.fetch("/logs",{method:"POST",body:JSON.stringify({logs:e.map(t=>({...t,payload:{...t.payload,session_id:_optionalChain([t, 'access', _ => _.payload, 'optionalAccess', _2 => _2.sessionId]),seq_id:_optionalChain([t, 'access', _3 => _3.payload, 'optionalAccess', _4 => _4.seqId]),parent_seq_id:_optionalChain([t, 'access', _5 => _5.payload, 'optionalAccess', _6 => _6.parentSeqId])}}))})}),console.log(`Published ${e.length} messages!`)}catch(t){console.error(`Failed to publish messages: ${t}`)}}};exports.a = o;
//# sourceMappingURL=chunk-SLNISFDV.cjs.map