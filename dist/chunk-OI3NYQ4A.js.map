{"version":3,"sources":["../src/httpClient.ts"],"sourcesContent":["import FetchClient from \"./fetchClient\";\n\nconst TOO_MANY_REQUESTS = 429;\nconst INTERNAL_SERVER_ERROR = 500;\n\ninterface HttpClientOptions {\n  apiKey: string;\n  baseURL: string;\n}\n\n/**\n * The HttpClient provides methods to perform HTTP requests.\n * The `fetch` method is used to make a request to a specified endpoint.\n * It includes retry logic for transient errors, where it will retry the request\n * according to the `maxRetries` and `retryDelay` parameters.\n * For non-transient errors, it will fail fast and not retry the request.\n * @param input - The endpoint to which the request will be made.\n * @param init - The request options.\n * @param maxRetries - The maximum number of retries for the request.\n * @param retryDelay - The delay between retries.\n * @returns A promise that resolves to the response of the request, or rejects\n *          with an error if the request fails or all retries are exhausted.\n */\nexport class HttpClient {\n  apiKey: string;\n  baseURL: string;\n  fetchClient: FetchClient;\n  debug: boolean = false;\n  retries: number = 3;\n\n  constructor(opts: HttpClientOptions) {\n    this.apiKey = opts.apiKey;\n    this.baseURL = this.sanitizeBaseUrl(opts.baseURL);\n    this.fetchClient = new FetchClient();\n    this.debug = process.env.NODE_ENV === \"development\";\n  }\n\n  /**\n   * Sanitizes the base URL by trimming whitespace and removing trailing slashes.\n   * @param baseURL - The base URL to sanitize.\n   * @returns The sanitized base URL.\n   */\n  private sanitizeBaseUrl(baseURL: string): string {\n    return baseURL.trim().replace(/\\/$/, \"\");\n  }\n\n  async fetch(\n    input: string,\n    init?: RequestInit | undefined,\n  ): Promise<Response> {\n    const url = this.baseURL + input;\n\n    const requestInit = {\n      ...init,\n      headers: {\n        ...init?.headers,\n        \"Content-Type\": init?.headers?.[\"Content-Type\"] ?? \"application/json\",\n        authorization: `Bearer ${this.apiKey}`,\n      },\n    };\n\n    const isDebug = this.debug;\n\n    if (isDebug) {\n      console.debug(\n        `\\nFetching URL: ${url}` +\n          `\\nMethod: ${requestInit.method || \"GET\"}` +\n          `${requestInit.body ? `\\nBody: ${requestInit.body}` : \"\"}` +\n          `\\nHeaders: ${JSON.stringify(requestInit.headers, null, 2)}`,\n      );\n    }\n\n    const numRetries = this.retries;\n    const resp = await this.fetchClient.fetchRetry(url, {\n      ...requestInit,\n      retryOn: function (attempt, error, response) {\n        if (attempt >= numRetries) return false;\n\n        // Retry on too many requests, internal server error, or TypeError\n        const status = response?.status;\n\n        return (\n          error instanceof TypeError ||\n          status === TOO_MANY_REQUESTS ||\n          (status !== undefined && status >= INTERNAL_SERVER_ERROR)\n        );\n      },\n      retryDelay: function (attempt, error, response, input) {\n        console.warn(\n          `Fetch attempt #${attempt}: input=${input}, error=${error?.message}, response status=${response?.status}, response status text=${response?.statusText}`,\n        );\n        return Math.pow(2, attempt) * 1000;\n      },\n    });\n\n    if (isDebug) {\n      console.debug(`Response for ${url}: ${resp.status} ${resp.statusText}\\n`);\n    }\n\n    return resp;\n  }\n}\n"],"mappings":"+CAEA,IAAMA,EAAoB,IACpBC,EAAwB,IAoBjBC,EAAN,KAAiB,CAOtB,YAAYC,EAAyB,CANrCC,EAAA,eACAA,EAAA,gBACAA,EAAA,oBACAA,EAAA,aAAiB,IACjBA,EAAA,eAAkB,GAGhB,KAAK,OAASD,EAAK,OACnB,KAAK,QAAU,KAAK,gBAAgBA,EAAK,OAAO,EAChD,KAAK,YAAc,IAAIE,EACvB,KAAK,MAAQ,QAAQ,IAAI,WAAa,aACxC,CAOQ,gBAAgBC,EAAyB,CAC/C,OAAOA,EAAQ,KAAK,EAAE,QAAQ,MAAO,EAAE,CACzC,CAEA,MAAM,MACJC,EACAC,EACmB,CACnB,IAAMC,EAAM,KAAK,QAAUF,EAErBG,EAAc,CAClB,GAAGF,EACH,QAAS,CACP,GAAGA,GAAM,QACT,eAAgBA,GAAM,UAAU,cAAc,GAAK,mBACnD,cAAe,UAAU,KAAK,MAAM,EACtC,CACF,EAEMG,EAAU,KAAK,MAEjBA,GACF,QAAQ,MACN;AAAA,gBAAmBF,CAAG;AAAA,UACPC,EAAY,QAAU,KAAK,GACrCA,EAAY,KAAO;AAAA,QAAWA,EAAY,IAAI,GAAK,EAAE;AAAA,WAC1C,KAAK,UAAUA,EAAY,QAAS,KAAM,CAAC,CAAC,EAC9D,EAGF,IAAME,EAAa,KAAK,QAClBC,EAAO,MAAM,KAAK,YAAY,WAAWJ,EAAK,CAClD,GAAGC,EACH,QAAS,SAAUI,EAASC,EAAOC,EAAU,CAC3C,GAAIF,GAAWF,EAAY,MAAO,GAGlC,IAAMK,EAASD,GAAU,OAEzB,OACED,aAAiB,WACjBE,IAAWjB,GACViB,IAAW,QAAaA,GAAUhB,CAEvC,EACA,WAAY,SAAUa,EAASC,EAAOC,EAAUT,EAAO,CACrD,eAAQ,KACN,kBAAkBO,CAAO,WAAWP,CAAK,WAAWQ,GAAO,OAAO,qBAAqBC,GAAU,MAAM,0BAA0BA,GAAU,UAAU,EACvJ,EACO,KAAK,IAAI,EAAGF,CAAO,EAAI,GAChC,CACF,CAAC,EAED,OAAIH,GACF,QAAQ,MAAM,gBAAgBF,CAAG,KAAKI,EAAK,MAAM,IAAIA,EAAK,UAAU;AAAA,CAAI,EAGnEA,CACT,CACF","names":["TOO_MANY_REQUESTS","INTERNAL_SERVER_ERROR","HttpClient","opts","__publicField","fetchClient_default","baseURL","input","init","url","requestInit","isDebug","numRetries","resp","attempt","error","response","status"]}